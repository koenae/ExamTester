@page "/"
@inject ExamService ExamService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="home-page">
    <div class="hero-section">
        <h1>Exam Simulator</h1>
        <p class="hero-subtitle">Practice for your certification exams with realistic simulations</p>
    </div>

    <div class="upload-section">
        <div class="upload-card">
            <div class="upload-zone @(IsDragOver ? "drag-over" : "") @(IsLoading ? "loading" : "")"
                 @ondragover="HandleDragOver"
                 @ondragover:preventDefault
                 @ondragleave="HandleDragLeave"
                 @ondrop="HandleDrop"
                 @ondrop:preventDefault>

                @if (IsLoading)
                {
                    <div class="upload-loading">
                        <div class="spinner"></div>
                        <p>Loading exam...</p>
                    </div>
                }
                else if (LoadedExam != null)
                {
                    <div class="exam-preview">
                        <svg class="check-circle" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="9 12 12 15 16 10"/>
                        </svg>
                        <h3>@LoadedExam.ExamTitle</h3>
                        <div class="exam-details">
                            <div class="detail-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                                <span>@LoadedExam.TimeLimit minutes</span>
                            </div>
                            <div class="detail-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 11l3 3L22 4"/>
                                    <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                                </svg>
                                <span>@LoadedExam.Questions.Count questions</span>
                            </div>
                            <div class="detail-item">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                                <span>@LoadedExam.PassingScore% to pass</span>
                            </div>
                        </div>
                        <button class="start-btn" @onclick="StartExam">
                            Start Exam
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"/>
                                <polyline points="12 5 19 12 12 19"/>
                            </svg>
                        </button>
                        <button class="reset-btn" @onclick="ResetExam">Choose different file</button>
                    </div>
                }
                else
                {
                    <div class="upload-prompt">
                        <svg class="upload-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <h3>Upload Exam File</h3>
                        <p>Drag and drop your JSON exam file here, or click to browse</p>
                        <InputFile OnChange="HandleFileSelected" accept=".json" class="file-input" id="file-input" />
                        <label for="file-input" class="browse-btn">Browse Files</label>
                    </div>
                }
            </div>

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="error-message">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                    @ErrorMessage
                </div>
            }
        </div>

        <div class="info-card">
            <h3>JSON Format</h3>
            <p>Your exam file should follow this structure:</p>
            <pre><code>{
  "examTitle": "Sample Exam",
  "timeLimit": 60,
  "passingScore": 70,
  "questions": [
    {
      "id": 1,
      "text": "Question text?",
      "options": ["A", "B", "C", "D"],
      "correctAnswer": 0,
      "explanation": "Why A is correct"
    }
  ]
}</code></pre>
        </div>
    </div>
</div>

@code {
    private Models.Exam? LoadedExam;
    private bool IsDragOver;
    private bool IsLoading;
    private string? ErrorMessage;

    private void HandleDragOver() => IsDragOver = true;
    private void HandleDragLeave() => IsDragOver = false;

    private async Task HandleDrop()
    {
        IsDragOver = false;
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        ErrorMessage = null;
        IsLoading = true;

        try
        {
            var file = e.File;
            if (file == null)
            {
                ErrorMessage = "No file selected";
                return;
            }

            if (!file.Name.EndsWith(".json", StringComparison.OrdinalIgnoreCase))
            {
                ErrorMessage = "Please select a JSON file";
                return;
            }

            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();

            LoadedExam = await ExamService.LoadExamFromJsonAsync(content);

            if (LoadedExam == null)
            {
                ErrorMessage = "Invalid exam file format. Please check your JSON structure.";
            }
            else if (LoadedExam.Questions.Count == 0)
            {
                ErrorMessage = "The exam file contains no questions.";
                LoadedExam = null;
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading file: {ex.Message}";
            LoadedExam = null;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void StartExam()
    {
        if (LoadedExam != null)
        {
            ExamService.StartExam();
            Navigation.NavigateTo("/exam");
        }
    }

    private void ResetExam()
    {
        LoadedExam = null;
        ErrorMessage = null;
        ExamService.ResetExam();
    }
}
